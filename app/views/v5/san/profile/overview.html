{% extends "/layouts/v5.html" %}

{% set currentpage = "overview" %}

{% block beforeContent %}
  <div class="govuk-width-container ">
    <nav class="govuk-breadcrumbs govuk-!-display-none-print" aria-label="Breadcrumb">
      <ol class="govuk-breadcrumbs__list">
        <li class="govuk-breadcrumbs__list-item">
          <a class="govuk-breadcrumbs__link" href="/{{ v }}/">Digital Prison Services</a>
        </li>
        <li class="govuk-breadcrumbs__list-item">
          <a class="govuk-breadcrumbs__link" href="/{{ v }}/san/">Manage support for additional needs</a>
        </li>
      </ol>
    </nav>
  </div>
{% endblock %}

{% block content %}

{% for prisoner in data[v+'prisoners'] %}
  {% if prisoner.prisonerNumber == ref %}

  <div class="govuk-width-container">
    <div class="govuk-grid-row">
      <div class="govuk-grid-column-full">
        <h1 class="govuk-heading-l">{{ prisoner.firstName }} {{ prisoner.lastName }}’s support for additional needs</h1>
      </div>

      <div class="govuk-grid-column-full">
        {% if data['prevurl'] == "check-answers" %}
          {{ mojAlert({
            variant: "success",
            title: "Education support plan created",
            dismissible: false
          }) }}
        {% endif %}

        {% include "includes/"+v+"/san-miniprofile.html" %}
      </div>
    </div>

    <div class="govuk-grid-row">
      {% include "includes/"+v+"/san-subnav.html" %}
    </div>

    <div class="govuk-grid-row">

      {# ================= LEFT COLUMN ================= #}
      <div class="govuk-grid-column-two-thirds">

        {% set cats = [] %}

        {# Challenges + Strengths side by side #}
        <div class="govuk-grid-row app-equal-cards">
          <div class="govuk-grid-column-one-half app-card-col">
            <section class="app-summary-card app-summary-card--fill govuk-!-margin-bottom-6">
              <header class="app-summary-card__header">
                <h2 class="app-summary-card__title">Challenges</h2>
                <div class="app-summary-card__actions">
                  <a class="govuk-link govuk-link--no-visited-state" href="/{{ v }}/san/{{ prisoner.prisonerNumber }}/profile/challenges">View challenges</a>
                </div>
              </header>
              <div class="app-summary-card__body">

                {% set areChallenges = 0 %}
                {% for categories in data[v+'categories'] %}
                  {% for needs in prisoner.needsChallenges %}
                    {% if needs.needsChallengeCategory == categories.categoryName %}
                      {% if not categories.categoryName in cats %}
                        {% set cats = (cats.push(categories.categoryName), cats) %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                {% endfor %}

                {% for cat in cats %}
                  {% for needs in prisoner.needsChallenges %}
                    {% if needs.needsChallengeCategory == cat %}
                      {% set areChallenges = areChallenges + 1 %}
                      <p class="govuk-body">{{ cat }}</p>
                    {% endif %}
                  {% endfor %}
                {% endfor %}

                {% if areChallenges > 0 %}
                 
                {% else %}
                  <p class="govuk-body">No challenges recorded</p>
                {% endif %}
              </div>
            </section>
          </div>

          <div class="govuk-grid-column-one-half app-card-col">
            <section class="app-summary-card app-summary-card--fill govuk-!-margin-bottom-6">
              <header class="app-summary-card__header">
                <h2 class="app-summary-card__title">Strengths</h2>
                <div class="app-summary-card__actions">
                  <a class="govuk-link govuk-link--no-visited-state" href="/{{ v }}/san/{{ prisoner.prisonerNumber }}/profile/strengths">View strengths</a>
                </div>
              </header>
              <div class="app-summary-card__body">

                {% set areStrengths = 0 %}
                {% for categories in data[v+'categories'] %}
                  {% for needs in prisoner.needsStrengths %}
                    {% if needs.needsStrengthCategory == categories.categoryName %}
                      {% if not categories.categoryName in cats %}
                        {% set cats = (cats.push(categories.categoryName), cats) %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                {% endfor %}

                {% for cat in cats %}
                  {% for needs in prisoner.needsStrengths %}
                    {% if needs.needsStrengthCategory == cat %}
                      {% set areStrengths = areStrengths + 1 %}
                      <p class="govuk-body">{{ cat }}</p>
                    {% endif %}
                  {% endfor %}
                {% endfor %}

                {% if areStrengths > 0 %}
                {% else %}
                  <p class="govuk-body">No strengths recorded</p>
                {% endif %}
              </div>
            </section>
          </div>

        </div>
        {# Support strategies (grouped by category, divider between items) #}
        <section class="app-summary-card govuk-!-margin-bottom-6">
          <header class="app-summary-card__header">
            <h2 class="app-summary-card__title">Support strategies</h2>
            <div class="app-summary-card__actions">
              <a class="govuk-link govuk-link--no-visited-state"
                 href="/{{ v }}/san/{{ prisoner.prisonerNumber }}/profile/support-strategies">
                View support strategies
              </a>
            </div>
          </header>
        
          <div class="app-summary-card__body">
            {% if prisoner.needsSupport and prisoner.needsSupport.length %}

            {# collect categories that have NON-archived items #}
            {% set supCats = [] %}
            {% for n in prisoner.needsSupport %}
              {% if not n.needsSupportArchiveReason and not (n.needsSupportCategory in supCats) %}
                {% set supCats = (supCats.push(n.needsSupportCategory), supCats) %}
              {% endif %}
            {% endfor %}
          
            {% if supCats.length %}
              {% for cat in supCats %}
          
                {# gather items for this category #}
                {% set items = [] %}
                {% for n in prisoner.needsSupport %}
                  {% if n.needsSupportCategory == cat and not n.needsSupportArchiveReason %}
                    {% set items = (items.push(n), items) %}
                  {% endif %}
                {% endfor %}
          
                <dl class="govuk-summary-list san-needs-list govuk-!-margin-bottom-0">
          
                  {# Category heading row – no underline #}
                  <div class="govuk-summary-list__row san-heading-row">
                    <dt class="govuk-summary-list__key govuk-!-font-weight-regular">
                      <p class="govuk-body govuk-!-font-weight-bold govuk-!-margin-bottom-1">{{ cat }}</p>
                    </dt>
                    <dd class="govuk-summary-list__value"></dd>
                  </div>
          
                  {# Item rows – use native summary-list borders between items #}
                  {% for needs in items %}
                    <div class="govuk-summary-list__row">
                      <dt class="govuk-summary-list__key govuk-!-font-weight-regular">
                        {{ needs.needsSupportDescription | safe }}
                      </dt>
                      <dd class="govuk-summary-list__value"></dd>
                    </div>
                  {% endfor %}
                  {# draw a divider only if this is NOT the last category #}
                  {% if not loop.last %}
                    <div class="govuk-summary-list__row san-endcap-row" aria-hidden="true">
                      <dt class="govuk-summary-list__key"></dt>
                      <dd class="govuk-summary-list__value"></dd>
                    </div>
                  {% endif %}
                </dl>
          
              {% endfor %}
            {% else %}
              <p class="govuk-body govuk-!-margin-top-3">No support strategies recorded</p>
            {% endif %}
          
          {% else %}
            <p class="govuk-body govuk-!-margin-top-3">No support strategies recorded</p>
          {% endif %}
          
          </div>
        </section>
        
        

        {# Conditions full width #}
        <section class="app-summary-card govuk-!-margin-bottom-6">
          <header class="app-summary-card__header">
            <h2 class="app-summary-card__title">Conditions</h2>
            <div class="app-summary-card__actions">
              <a class="govuk-link govuk-link--no-visited-state"
              href="/v5/san/G2911GD/profile/conditions">
                View conditions
              </a>
            </div>
          </header>
        
          <div class="app-summary-card__body">
            {% if prisoner.conditions and prisoner.conditions.length %}
        
              {# Split confirmed vs self-declared #}
              {% set confirmed = [] %}
              {% set selfdeclared = [] %}
        
              {% for c in prisoner.conditions %}
                {% if c.conditionType and (c.conditionType | lower) == "confirmed diagnosis" %}
                  {% set confirmed = (confirmed.push(c), confirmed) %}
                {% elif c.conditionType and (c.conditionType | lower) == "self-declared" %}
                  {% set selfdeclared = (selfdeclared.push(c), selfdeclared) %}
                {% endif %}
              {% endfor %}
              {# Confirmed diagnoses section #}
              {# Confirmed diagnoses section #}
              {% if confirmed.length %}
                <h3 class="govuk-heading-s govuk-!-margin-bottom-2 govuk-!-margin-top-1">Confirmed diagnoses</h3>
              
                <dl class="govuk-summary-list san-needs-list govuk-!-margin-bottom-0">
                  {% for c in confirmed %}
                    <div class="govuk-summary-list__row">
                      <dt class="govuk-summary-list__key govuk-!-font-weight-regular">
                        <p class="govuk-body govuk-!-font-weight-bold govuk-!-margin-bottom-1">{{ c.conditionName }}</p>
                        {% if c.conditionDetail %}
                          <p class="govuk-body govuk-!-margin-bottom-0">{{ c.conditionDetail }}</p>
                        {% endif %}
                      </dt>
                      <dd class="govuk-summary-list__value"></dd>
                    </div>
                  {% endfor %}
                </dl>
              {% endif %}
              
              {# 🔹 Divider between confirmed and self-declared sections only #}
              {% if confirmed.length and selfdeclared.length %}
                <div style="border-top:1px solid #b1b4b6; margin:16px 0;"></div>
              {% endif %}
              
              {# Self-declared conditions section #}
              {% if selfdeclared.length %}
                <h3 class="govuk-heading-s govuk-!-margin-bottom-2 govuk-!-margin-top-1">Self-declared conditions</h3>
              
                <dl class="govuk-summary-list san-needs-list govuk-!-margin-bottom-0">
                  {% for c in selfdeclared %}
                    <div class="govuk-summary-list__row">
                      <dt class="govuk-summary-list__key govuk-!-font-weight-regular">
                        <p class="govuk-body govuk-!-font-weight-bold govuk-!-margin-bottom-1">{{ c.conditionName }}</p>
                        {% if c.conditionDetail %}
                          <p class="govuk-body govuk-!-margin-bottom-0">{{ c.conditionDetail }}</p>
                        {% endif %}
                      </dt>
                      <dd class="govuk-summary-list__value"></dd>
                    </div>
                  {% endfor %}
                </dl>
              {% endif %}
              
              {% if not confirmed.length and not selfdeclared.length %}
                <p class="govuk-body govuk-!-margin-top-2">No conditions recorded</p>
              {% endif %}
        
            {% else %}
              <p class="govuk-body">No conditions recorded</p>
            {% endif %}
          </div>
        </section>
        
        


        {# Screening and assessment #}
<section class="app-summary-card govuk-!-margin-bottom-6">
  <header class="app-summary-card__header">
    <h2 class="app-summary-card__title">Screening and assessment</h2>
    <div class="app-summary-card__actions">
      <a class="govuk-link govuk-link--no-visited-state"
         href="/{{ v }}/san/{{ prisoner.prisonerNumber }}/screener/results">
        Record screener results
      </a>
    </div>
  </header>

  <div class="app-summary-card__body">
    <p class="govuk-body govuk-!-margin-bottom-4">
      This information is from the education team entered in Curious
    </p>

    {% if prisoner.screener %}
      {% set scr = prisoner.screener %}
      <dl class="govuk-summary-list govuk-!-margin-bottom-0">

        {# Site line shown as a bold label spanning the row #}
        <div class="govuk-summary-list__row san-screener-site">
          <dt class="govuk-summary-list__key govuk-!-font-weight-bold">
            {{ scr.site or '-' }}
          </dt>
          <dd class="govuk-summary-list__value"></dd>
        </div>

        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">Assessment date</dt>
          <dd class="govuk-summary-list__value">
            {{ (scr.assessmentDate and (scr.assessmentDate | govukDate)) or '-' }}
          </dd>
        </div>

        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">Assessment outcome</dt>
          <dd class="govuk-summary-list__value">{{ scr.outcome or '-' }}</dd>
        </div>

        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">Referred to</dt>
          <dd class="govuk-summary-list__value">{{ scr.referredTo or '-' }}</dd>
        </div>
      </dl>
    {% else %}
      <p class="govuk-body">No screening or assessment recorded.</p>
    {% endif %}
  </div>
</section>


      </div>
      

      <div class="govuk-grid-column-one-third govuk-!-padding-left-5 govuk-!-margin-top-0">
        {% include "includes/"+v+"/san-actions-add.html" %}
      </div>

    </div>
  </div>

  {% endif %}
{% endfor %}

{% endblock %}
